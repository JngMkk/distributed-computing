Two-Phase Commmit 알고리즘은 분산 데이터베이스 시스템에서 트랜잭션의 원자성을 보장하기 위해 사용되는 분산 합의 알고리즘. 이 알고리즘은 모든 참여자가 트랜잭션의 커밋 또는 롤백에 동의해야만 트랜잭션이 완료되도록 함.

#### 과정
1. Prepare Phase(준비 단계): 코디네이터는 모든 참여 노드에게 트랜잭션 커밋 준비하라는 요청을 보냄. 각 노드는 트랜잭션을 안전하게 커밋할 수 있는지 검사한 후, yes or no로 대답함.
2. Commit/Rollback Phase: 모든 노드로부터 yes 응답을 받으면, 코디네이터는 모든 노드에 커밋 명령을 보냄. 하나라도 no를 보낸 노드가 있으면, 코디네이터는 모든 노드에게 롤백 명령을 보내 트랜잭션을 중단함.

#### 장점
- 일관성 보장: 트랜잭션의 원자성을 보장함. 즉, 모든 노드가 트랜잭션을 완료하거나 롤백함
- 간단한 로직

#### 단점
- 실패 지점: 코디네이터 또는 어느 하나의 노드에 장애가 발생하면 전체 시스템이 block될 가능성이 있음
- 지연 시간: 두 단계의 완료를 위해 모든 노드의 응답을 기다려야 하므로 지연 시간이 길어짐
- 잠금 자원: 트랜잭션이 완료될 때까지 관련 자원이 잠기므로, 다른 트랜잭션에서 해당 자원을 사용할 수 없음

#### 안정성 보장을 위한 추가 조치
이 알고리즘에 참여하는 주체들(Coordinator, Nodes)이 장애를 겪고 있거나, 네트워크 분할이 발생을 살펴봐야 함.
- WAL(Write-Ahead Log): 모든 주체는 메시지를 송신하기 전에 log를 디스크에 저장함. 중단 후 다시 재구동했을 때, 디스크의 기록을 찾아 다음 동작을 처리. 예를 들어, Coordinator가 중단된 상태에서 정상으로 돌아와 기록을 확인했을 때, Commit 메시지를 보냈다는 기록이 없었다면 이체 명령을 취소함.
- 메시지 재전송: 노드가 중단되었다가 재구동했을 때, Coordinator에게 메시지를 전달받지 못한 상태라면 메시지를 재전송하여 Commit/Rollback을 진행.

#### 라이브니스 보장을 위한 추가 조치
- coordinator는 timeout 내에 응답이 오지 않으면 명령을 취소하고 재시도할 것을 알림(프로세스가 다시 수행되어야 하므로 비효율적)
- 노드 간 통신으로 서로의 상태를 확인하는 과정을 추가할 수 있음.
	- 옆 노드가 무응답 -> coordinator의 후속 명령을 기다림
	- 옆 노드가 coordinator로부터 받은 명령을 응답 -> 같은 명령 수행
	- NACK를 회신했다고 응답 -> Rollback
	- ACK 회신했다고 응답 -> 후속 명령 기다림

#### 대체 수단
- 3PC: 2PC의 block 문제를 해결하기 위해 고안된 알고리즘. pre-commit 단계를 통해 코디네이터와 노드 간 통신이 끊기더라도 자동으로 결정을 내릴 수 있음. 이는 네트워크 분할 시에도 더 나은 내결함성을 제공함.
- Paxos, Raft와 같은 분산 합의 알고리즘: 분산 시스템에서 널리 사용되는 합의 알고리즘으로, 여러 개의 코디네이터를 두고 과반수의 동의로 트랜잭션을 커밋하는 방식. 여러 노드가 서로 다른 입력을 받고도 일관된 단일 값에 합의할 수 있음. 2PC보다 더 복잡하지만, 네트워크 분할과 노드 장애에 강한 내성을 가짐.
- Saga Pattern: 트랜잭션을 여러 개의 작은 트랜잭션으로 나누고, 각 트랜잭션이 실패할 경우 보상 트랜잭션을 실행하여 롤백하는 방식. 마이크로서비스 아키텍처에서 자주 사용됨.
- Eventual Consistency(최종 일관성) 모델: 일시적인 불일치를 허용하고, 최종적으로 일관성을 보장하는 방식. 가용성과 성능을 중시하는 시스템에서 사용.
